var __extends=this&&this.__extends||function(){var o=function(t,e){o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return o(t,e)};return function(t,e){o(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}}();var sunnet;(function(t){var e;(function(t){t[t["OK"]=0]="OK";t[t["IO_ERROR"]=-1]="IO_ERROR";t[t["PARSE_ERROR"]=-2]="PARSE_ERROR"})(e=t.HttpResStatus||(t.HttpResStatus={}));var r;(function(t){t[t["NSL_SEND_DATA"]=1]="NSL_SEND_DATA";t[t["NSL_RECV_DATA"]=2]="NSL_RECV_DATA"})(r=t.MsgQIdEnum||(t.MsgQIdEnum={}));var s;(function(t){t[t["CONNECTED"]=0]="CONNECTED";t[t["CONNECTING"]=1]="CONNECTING";t[t["DISCONNECTED"]=2]="DISCONNECTED"})(s=t.NetConnectionStateEnum||(t.NetConnectionStateEnum={}));var n=function(n){__extends(t,n);function t(t){var e=n.call(this,suncore.MsgQModEnum.NSL)||this;e.$closedByError=false;e.$socket=null;e.$state=s.DISCONNECTED;e.$pipeline=null;e.$dispatcher=null;e.$name=t;e.$pipeline=new i(e);e.$dispatcher=new suncom.EventSystem;return e}t.prototype.connect=function(t,e,n){if(n===false){this.close(false)}else{this.close(this.$closedByError)}this.$ip=t;this.$port=e;this.$state=s.CONNECTING;this.$socket=new Laya.Socket;this.$socket.endian=Laya.Byte.LITTLE_ENDIAN;this.$socket.on(Laya.Event.OPEN,this,this.$onOpen);this.$socket.on(Laya.Event.CLOSE,this,this.$onClose);this.$socket.on(Laya.Event.ERROR,this,this.$onError);this.$socket.on(Laya.Event.MESSAGE,this,this.$onMessage);this.$socket.connectByUrl("ws://"+t+":"+e);if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 请求连接 ws://"+this.$ip+":"+this.$port)}};t.prototype.close=function(t){if(t===void 0){t=false}if(t===false){this.$closedByError=false}else if(this.$state===s.CONNECTED){this.$closedByError=true;this.dispatchEvent(m.CLEAR_MESSAGE_QUEUE);this.facade.sendNotification($.SOCKET_STATE_CHANGE,1)}if(this.$socket!==null){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 关闭连接 ws://"+this.$ip+":"+this.$port)}this.$socket.off(Laya.Event.OPEN,this,this.$onOpen);this.$socket.off(Laya.Event.CLOSE,this,this.$onClose);this.$socket.off(Laya.Event.ERROR,this,this.$onError);this.$socket.off(Laya.Event.MESSAGE,this,this.$onMessage);this.$socket.close();this.$socket=null}if(this.$state!==s.DISCONNECTED){this.dispatchEvent(m.SOCKET_DISCONNECTED,t)}if(t===false){this.dispatchEvent(m.KILL_WATCH_DOG)}this.$state=s.DISCONNECTED};t.prototype.send=function(t){if(this.$state===s.CONNECTED){this.$socket.send(t)}if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.error("NetConnection=> sendBytes 发送数据失败！！！")}};t.prototype.flush=function(){this.$socket.flush()};t.prototype.sendBytes=function(t,e,n,o){if(e===void 0){e=null}this.$pipeline.send(t,e,n,o)};t.prototype.$onOpen=function(){this.$state=s.CONNECTED;if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 网络连接成功！")}if(this.$closedByError===true){this.$closedByError=false;this.facade.sendNotification($.SOCKET_STATE_CHANGE,0)}this.dispatchEvent(m.SOCKET_CONNECTED)};t.prototype.$onClose=function(){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 连接异常关闭！")}this.close(true)};t.prototype.$onError=function(){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 连接异常断开！")}this.close(true)};t.prototype.$onMessage=function(t){this.$pipeline.recv(null,null,null)};t.prototype.dispatchCancel=function(){this.$dispatcher.dispatchCancel()};t.prototype.dispatchEvent=function(t,e,n){this.$dispatcher.dispatchEvent(t,e,n)};t.prototype.addEventListener=function(t,e,n,o,i){this.$dispatcher.addEventListener(t,e,n,o,i)};t.prototype.removeEventListener=function(t,e,n){this.$dispatcher.removeEventListener(t,e,n)};Object.defineProperty(t.prototype,"name",{get:function(){return null},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"ip",{get:function(){return this.$ip},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"port",{get:function(){return this.$port},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"state",{get:function(){return this.$state},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"input",{get:function(){var t=this.$socket||null;if(t===null){return null}return this.$socket.input},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"output",{get:function(){var t=this.$socket||null;if(t===null){return null}return this.$socket.output},enumerable:true,configurable:true});Object.defineProperty(t.prototype,"pipeline",{get:function(){return this.$pipeline},enumerable:true,configurable:true});t.HEAD_LENGTH=28;return t}(puremvc.Notifier);t.NetConnection=n;var o=function(n){__extends(t,n);function t(t){var e=n.call(this,suncore.MsgQModEnum.NSL)||this;e.$connection=t;e.$connection.addEventListener(m.SOCKET_CONNECTED,e.$onConnected,e);e.$connection.addEventListener(m.SOCKET_DISCONNECTED,e.$onDisconnected,e);return e}t.prototype.destroy=function(){this.$connection.removeEventListener(m.SOCKET_CONNECTED,this.$onConnected,this);this.$connection.removeEventListener(m.SOCKET_DISCONNECTED,this.$onDisconnected,this);this.$connection=null};t.prototype.$onConnected=function(){};t.prototype.$onDisconnected=function(t){};t.prototype.send=function(t,e,n,o){return[t,e,n,o]};t.prototype.recv=function(t,e,n,o){return[t,e,n,o]};return t}(puremvc.Notifier);t.NetConnectionInterceptor=o;var i=function(){function t(t){this.$items=[];this.$connection=t}t.prototype.destroy=function(){while(this.$items.length>0){var t=this.$items.shift();t.interceptor.destroy()}};t.prototype.add=function(t,e){var n=new c;n.type=typeof t==="string"?t:null;n.interceptor=typeof t!=="string"?new t(this.$connection):new e(this.$connection);this.$items.push(n)};t.prototype.remove=function(t){for(var e=0;e<this.$items.length;e++){var n=this.$items[e].interceptor;if(n instanceof t){this.$items.splice(e,1);n.destroy();break}}};t.prototype.recv=function(t,e,n,o){var i=[t,e,n,o];for(var s=0;s<this.$items.length;s++){var r=this.$items[s];if(r.type==="send"){continue}var c=r.interceptor;i=c.recv.apply(c,i);if(i===null){return}}if(i[3]===void 0){if(suncom.Global.debugMode){suncom.Logger.warn("NetConnectionPipeline=> decode 意外的指令 cmd:"+i[0].toString()+", buff:"+(i[1]?"[Object]":"null"))}}};t.prototype.send=function(t,e,n,o){for(var i=this.$items.length-1;i>-1;i--){var s=this.$items[i];if(s.type==="recv"){continue}var r=s.interceptor;var c=r.send.call(r,t,e,n,o);if(c===null){return null}}return null};return t}();t.NetConnectionPipeline=i;var c=function(){function t(){}return t}();t.NetConnectionPipelineItem=c;var u=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.recv=function(t,e,n,o){if(o!==void 0){return[t,e,n,o]}var i=this.$decode(t,n);if(i===null){return[t,e,n,o]}if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("消息解析成功 ==> "+JSON.stringify(i))}if(i===n){throw Error("请勿返回未处理的消息！！！")}var s={id:t,name:null,data:i};suncore.MsgQ.send(suncore.MsgQModEnum.NSL,suncore.MsgQModEnum.NSL,r.NSL_RECV_DATA,s);return[t,e,n,i]};return e}(o);t.NetConnectionProtobufDecoder=u;var a=function(n){__extends(t,n);function t(t){var e=n.call(this,t)||this;e.$retryCount=0;e.$connection.addEventListener(m.KILL_WATCH_DOG,e.$onKillWatchDog,e);return e}t.prototype.destroy=function(){this.$connection.removeEventListener(m.KILL_WATCH_DOG,this.$onKillWatchDog,this);n.prototype.destroy.call(this)};t.prototype.$onConnected=function(){this.$retryCount=0;this.$onKillWatchDog()};t.prototype.$onDisconnected=function(t){if(t===true){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT)===suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log("NetConnectionWatchDog=> 网络连接异常，"+d.TCP_RETRY_DELAY+"毫秒后重连！")}if(this.$retryCount>=d.TCP_MAX_RETRY_TIME){this.$retryCount=0;this.facade.sendNotification($.SOCKET_STATE_CHANGE,2);return}this.$ip=this.$connection.ip;this.$port=this.$connection.port;this.$timerId=suncore.System.addTimer(suncore.ModuleEnum.SYSTEM,d.TCP_RETRY_DELAY,this.$onDoingConnect,this);this.facade.sendNotification($.SOCKET_STATE_ANOMALY,this.$retryCount)}};t.prototype.$onKillWatchDog=function(){this.$timerId=suncore.System.removeTimer(this.$timerId)};t.prototype.$onDoingConnect=function(){if(this.$connection.state===s.DISCONNECTED){this.$retryCount++;this.facade.sendNotification($.SOCKET_RETRY_CONNECT,this.$retryCount);this.$connection.connect(this.$ip,this.$port,true)}else{if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("检测狗不能正常工作，因为：","state:"+suncom.Common.convertEnumToString(this.$connection.state,s))}}};return t}(o);t.NetConnectionWatchDog=a;var E=function(){function t(){this.$proto=null;this.$commands=null;this.$protocals=null}t.getInstance=function(){return t.instance};t.prototype.buildProto=function(t){var e=new Laya.Browser.window.protobuf.Root;var n=Laya.loader.getRes(t);Laya.Browser.window.protobuf.parse(n,e,{keepCase:true});this.$proto=e};t.prototype.buildProtocal=function(t){var e=Laya.loader.getRes(t);this.$commands=Object.keys(e.data);this.$protocals=e.data};t.prototype.buildProtocalJson=function(t){this.$commands=Object.keys(t);this.$protocals=t};t.prototype.getProtocalByCommand=function(t){return this.$protocals[t]||null};t.prototype.getProtocalByName=function(t){for(var e=0;e<this.$commands.length;e++){var n=this.$commands[e];var o=this.getProtocalByCommand(n);if(o===null){continue}if(o.Name===t){return o}}return null};t.prototype.getProtoClass=function(t){return this.$proto.lookup(t)};t.prototype.getProtoEnum=function(t){return this.getProtoClass(t).values};t.prototype.encode=function(t,e){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){console.log("打包数据成功 ==> "+JSON.stringify(e))}return this.getProtoClass(t).encode(e).finish()};t.prototype.decode=function(t,e){return this.getProtoClass(t).decode(e)};t.instance=new t;return t}();t.ProtobufManager=E;var l=function(n){__extends(t,n);function t(t){var e=n.call(this,t)||this;e.$messages=[];e.$connection.addEventListener(m.CLEAR_MESSAGE_QUEUE,e.$onClearMessageQueue,e);return e}t.prototype.destroy=function(){this.$connection.removeEventListener(m.CLEAR_MESSAGE_QUEUE,this.$onClearMessageQueue,this);n.prototype.destroy.call(this)};t.prototype.$onConnected=function(){while(this.$messages.length){var t=this.$messages.pop();this.$connection.sendBytes(t.cmd,t.bytes,t.ip,t.port)}};t.prototype.$onClearMessageQueue=function(){this.$messages.length=0};t.prototype.$needCreate=function(t,e){if(t===void 0||e===void 0){return false}if(this.$connection.state===s.DISCONNECTED){return true}if(this.$connection.state===s.CONNECTED){if(this.$connection.ip!==t&&this.$connection.port!==e){return true}}return false};t.prototype.send=function(t,e,n,o){if(this.$needCreate(n,o)==false){if(this.$connection.state===s.CONNECTING){return null}return[t,e,n,o]}if(n!==void 0&&o!==void 0){this.$connection.connect(n,o,false)}var i={cmd:t,bytes:e,ip:n,port:o};this.$messages.push(i);return null};return t}(o);t.NetConnectionCreator=l;var f=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.recv=function(t,e,n,o){var i=this.$connection.input||null;if(i===null){console.error("Decoder 网络己断开！！！");return}t=i.getUint16();e=i.getUint16();var s=i.buffer.slice(i.pos);i.pos+=s.byteLength;n=new Uint8Array(s);if(t===d.HEARTBEAT_RESPONSE_COMMAND){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT)===suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log("响应心跳")}}else{if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("NetConnection=> 响应消息 cmd:"+t+", srvId:"+e+", length:"+n.byteLength)}}return[t,e,n,o]};return e}(o);t.NetConnectionDecoder=f;var h=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.send=function(t,e,n,o){var i=this.$connection.output||null;if(i===null){console.error("Encoder 网络己断开！！！");return}i.writeUint16(t);i.writeUint16(0);e!==null&&i.writeArrayBuffer(e);this.$connection.flush();if(t===d.HEARTBEAT_REQUEST_COMMAND){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT)===suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log("发送数据 cmd:"+t.toString()+", bytes:"+(e===null?0:e.byteLength))}}else if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("发送数据 cmd:"+t.toString()+", bytes:"+(e===null?0:e.byteLength))}return null};return e}(o);t.NetConnectionEncoder=h;var p=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.$onConnected=function(){this.$lastRecvTime=this.$lastSendTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.facade.registerObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this)};e.prototype.$onDisconnected=function(){this.facade.removeObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this)};e.prototype.$onEnterFrame=function(){var t=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);if(this.$lastRecvTime<this.$lastSendTime){if(t-this.$lastSendTime>1e3){this.$lastRecvTime=this.$lastSendTime;this.$connection.close(true)}}else if(t-this.$lastSendTime>3e3){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("send heatbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss",t))}this.$lastSendTime=t;var e=E.getInstance().encode("msg.Common_Heartbeat",{Cnt:1});this.$connection.sendBytes(d.HEARTBEAT_REQUEST_COMMAND,e)}};e.prototype.recv=function(t,e,n,o){if(t===d.HEARTBEAT_RESPONSE_COMMAND){this.$lastRecvTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}return[t,e,n,o]};return e}(o);t.NetConnectionHeartBeat=p;var d;(function(t){t.TCP_RETRY_DELAY=20*1e3;t.TCP_MAX_RETRY_TIME=10;t.HEARTBEAT_REQUEST_COMMAND=-1;t.HEARTBEAT_RESPONSE_COMMAND=-1})(d=t.Config||(t.Config={}));var m;(function(t){t.SOCKET_CONNECTED="sunnet.EventKey.SOCKET_CONNECTED";t.SOCKET_DISCONNECTED="sunnet.EventKey.SOCKET_DISCONNECTED";t.KILL_WATCH_DOG="sunnet.EventKey.KILL_WATCH_DOG";t.CLEAR_MESSAGE_QUEUE="sunnet.EventKey.CLEAR_MESSAGE_QUEUE"})(m=t.EventKey||(t.EventKey={}));var g;(function(t){var o=new suncom.EventSystem;function e(t,e){o.dispatchEvent(t,e)}t.notify=e;function n(t,e,n){o.addEventListener(t,e,n)}t.register=n;function i(t,e,n){o.removeEventListener(t,e,n)}t.unregister=i})(g=t.MessageNotifier||(t.MessageNotifier={}));var $;(function(t){t.SOCKET_STATE_CHANGE="sunnet.NotifyKey.SOCKET_STATE_CHANGE";t.SOCKET_STATE_ANOMALY="sunnet.NotifyKey.SOCKET_STATE_ANOMALY";t.SOCKET_RETRY_CONNECT="sunnet.NotifyKey.SOCKET_RETRY_CONNECT"})($=t.NotifyKey||(t.NotifyKey={}))})(sunnet||(sunnet={}));