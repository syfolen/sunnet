var __extends=this&&this.__extends||function(){var o=function(e,t){o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return o(e,t)};return function(e,t){o(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}}();var sunnet;(function(e){var t;(function(e){e[e["OK"]=0]="OK";e[e["IO_ERROR"]=-1]="IO_ERROR";e[e["PARSE_ERROR"]=-2]="PARSE_ERROR"})(t=e.HttpResStatus||(e.HttpResStatus={}));var r;(function(e){e[e["NSL_SEND_DATA"]=1]="NSL_SEND_DATA";e[e["NSL_RECV_DATA"]=2]="NSL_RECV_DATA"})(r=e.MsgQIdEnum||(e.MsgQIdEnum={}));var s;(function(e){e[e["CONNECTED"]=0]="CONNECTED";e[e["CONNECTING"]=1]="CONNECTING";e[e["DISCONNECTED"]=2]="DISCONNECTED"})(s=e.NetConnectionStateEnum||(e.NetConnectionStateEnum={}));var i;(function(e){e[e["RESET"]=0]="RESET";e[e["UPDATE"]=1]="UPDATE"})(i=e.ServerTimeUpdateFlagEnum||(e.ServerTimeUpdateFlagEnum={}));var u;(function(e){e[e["NONE"]=0]="NONE";e[e["GOOD"]=1]="GOOD";e[e["BAD"]=2]="BAD";e[e["UNSTABLE"]=3]="UNSTABLE"})(u=e.VirtualNetworkLevelEnum||(e.VirtualNetworkLevelEnum={}));var n=function(n){__extends(e,n);function e(e){var t=n.call(this,suncore.MsgQModEnum.NSL)||this;t.$hashId=0;t.$socket=null;t.$pipeline=null;t.$state=s.DISCONNECTED;t.$closedByError=false;t.$ping=0;t.$latency=0;t.$srvTime=0;t.$clientTime=0;t.$dispatcher=new suncom.EventSystem;t.$name=e;t.$pipeline=new a(t);S.connetionMap[e]=t;t.facade.registerObserver(suntdd.NotifyKey.GET_WEBSOCKET_INFO,t.$onGetWebSocketInfo,t);t.facade.registerObserver(suntdd.NotifyKey.TEST_WEBSOCKET_STATE,t.$onTestWebSocketState,t);t.facade.registerObserver(suntdd.NotifyKey.TEST_WEBSOCKET_PROTOCAL,t.$onTestWebSocketPacket,t);return t}e.prototype.$onGetWebSocketInfo=function(e){var t=S.connetionMap[e.name]||null;if(t===null){return}if(t.state===s.CONNECTED){e.state=suntdd.MSWSConnectionStateEnum.CONNECTED}else if(t.state===s.CONNECTING){e.state=suntdd.MSWSConnectionStateEnum.CONNECTING}else{e.state=suntdd.MSWSConnectionStateEnum.DISCONNECTED}};e.prototype.$onTestWebSocketState=function(e){this.testChangeState(e)};e.prototype.$onTestWebSocketPacket=function(e,t){this.testProtocal(e,t)};e.prototype.connect=function(e,t,n){var o=n===false?false:this.$closedByError;this.close(o);this.$ip=e;this.$port=t;this.$state=s.CONNECTING;this.$socket=new Laya.Socket;this.$socket.endian=Laya.Byte.LITTLE_ENDIAN;this.$socket.on(Laya.Event.OPEN,this,this.$onOpen);this.$socket.on(Laya.Event.CLOSE,this,this.$onClose);this.$socket.on(Laya.Event.ERROR,this,this.$onError);this.$socket.on(Laya.Event.MESSAGE,this,this.$onMessage);this.$hashId=suncom.Common.createHashId();if(suncom.Global.debugMode&suncom.DebugMode.TDD){}else{this.$socket.connectByUrl("ws://"+e+":"+t)}if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"Netconnection=> 请求连接 ws://"+this.$ip+":"+this.$port)}this.addEventListener(C.CLOSE_CONNECT_BY_VIRTUAL,this.$onError,this);this.facade.sendNotification(v.SOCKET_STATE_CHANGE,[this.$name,this.$state,false])};e.prototype.close=function(e){if(e===void 0){e=false}if(e===false){this.$closedByError=false}else if(this.$state===s.CONNECTED){this.$closedByError=true;this.dispatchEvent(C.CLEAR_REQUEST_DATA)}if(this.$socket!==null){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"Netconnection=> 关闭连接 ws://"+this.$ip+":"+this.$port)}this.$socket.off(Laya.Event.OPEN,this,this.$onOpen);this.$socket.off(Laya.Event.CLOSE,this,this.$onClose);this.$socket.off(Laya.Event.ERROR,this,this.$onError);this.$socket.off(Laya.Event.MESSAGE,this,this.$onMessage);this.$socket.close();this.$socket=null;this.$hashId=0}if(this.$state!==s.DISCONNECTED){this.dispatchEvent(C.SOCKET_DISCONNECTED,e)}if(e===false){this.dispatchEvent(C.KILL_WATCH_DOG)}if(this.$state!==s.DISCONNECTED){this.$state=s.DISCONNECTED;this.facade.sendNotification(v.SOCKET_STATE_CHANGE,[this.$name,this.$state,e])}};e.prototype.send=function(e){if(this.$state===s.CONNECTED){this.$socket.send(e)}else{suncom.Logger.error(suncom.DebugMode.ANY,"NetConnection=> 网络未连接，发送数据失败！！！")}};e.prototype.sendBytes=function(e,t,n,o){if(t===void 0){t=null}if(n===void 0){n=null}if(o===void 0){o=0}this.$pipeline.send(e,t,n,o)};e.prototype.flush=function(){this.$socket.flush()};e.prototype.testChangeState=function(e){if(suncom.Global.debugMode&suncom.DebugMode.TDD){var t=suncom.Handler.create(this,this.$onTestChangeState,[this.$hashId,e]);suncore.System.addMessage(suncore.ModuleEnum.SYSTEM,suncore.MessagePriorityEnum.PRIORITY_0,t)}};e.prototype.$onTestChangeState=function(e,t){if(this.$hashId===e){if(t===suntdd.MSWSStateEnum.CONNECTED){this.$onOpen()}else if(t===suntdd.MSWSStateEnum.CLOSE){this.$onClose()}else if(t===suntdd.MSWSStateEnum.ERROR){this.$onError()}}};e.prototype.testPacket=function(e){if(suncom.Global.debugMode&suncom.DebugMode.TDD){var t=suncom.Handler.create(this,this.$onTestPacket,[this.$hashId,e]);suncore.System.addMessage(suncore.ModuleEnum.SYSTEM,suncore.MessagePriorityEnum.PRIORITY_0,t)}};e.prototype.$onTestPacket=function(e,t){if(this.$hashId===e){var n=h.getInstance().getProtocalByCommand(t);this.facade.sendNotification(suntdd.NotifyKey.TEST_WEBSOCKET_SEND_DATA,n&&n.Name)}};e.prototype.testProtocal=function(e,t){if(suncom.Global.debugMode&suncom.DebugMode.TDD){var n=suncom.Handler.create(this,this.$onTestProtocal,[this.$hashId,e,t]);suncore.System.addMessage(suncore.ModuleEnum.SYSTEM,suncore.MessagePriorityEnum.PRIORITY_0,n)}};e.prototype.$onTestProtocal=function(e,t,n){if(this.$hashId===e){var o=h.getInstance().getProtocalByName(t);this.$pipeline.recv(o.Id,0,null,n)}};e.prototype.logMsgIsSent=function(e,t,n,o){var i=h.getInstance().getProtocalByCommand(e);var s=i===null?null:h.getInstance().decode("msg."+i.Name,t);if(e===y.HEARTBEAT_REQUEST_COMMAND){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"发送心跳 name:"+i.Name+", data:"+JSON.stringify(s))}}else if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"发送消息 name:"+i.Name+", data:"+JSON.stringify(s))}};e.prototype.dispatchCancel=function(){this.$dispatcher.dispatchCancel()};e.prototype.dispatchEvent=function(e,t,n){this.$dispatcher.dispatchEvent(e,t,n)};e.prototype.addEventListener=function(e,t,n,o,i){this.$dispatcher.addEventListener(e,t,n,o,i)};e.prototype.removeEventListener=function(e,t,n){this.$dispatcher.removeEventListener(e,t,n)};e.prototype.$onOpen=function(){this.$state=s.CONNECTED;if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"Netconnection=> 网络连接成功！")}this.dispatchEvent(C.SOCKET_CONNECTED);this.dispatchEvent(C.CACHE_SEND_BYTES,false);this.dispatchEvent(C.FLUSH_CACHED_BYTES);this.$closedByError=false;this.facade.sendNotification(v.SOCKET_STATE_CHANGE,[this.$name,this.$state,false])};e.prototype.$onClose=function(){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"Netconnection=> 连接异常关闭！")}this.close(true)};e.prototype.$onError=function(){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"Netconnection=> 连接异常断开！")}this.close(true)};e.prototype.$onMessage=function(e){this.$pipeline.recv(0,0,null,void 0)};Object.defineProperty(e.prototype,"name",{get:function(){return this.$name||null},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"ip",{get:function(){return this.$ip||null},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"port",{get:function(){return this.$port||0},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"state",{get:function(){return this.$state},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"input",{get:function(){if(this.$socket===null){return null}else{return this.$socket.input||null}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"output",{get:function(){if(this.$socket===null){return null}else{return this.$socket.output||null}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"ping",{get:function(){return this.$ping},set:function(e){this.$ping=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"latency",{get:function(){return this.$latency},set:function(e){this.$latency=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"srvTime",{get:function(){return this.$srvTime},set:function(e){this.$srvTime=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"clientTime",{get:function(){return this.$clientTime},set:function(e){this.$clientTime=e},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"pipeline",{get:function(){return this.$pipeline},enumerable:true,configurable:true});return e}(puremvc.Notifier);e.NetConnection=n;var o=function(n){__extends(e,n);function e(e){var t=n.call(this,suncore.MsgQModEnum.NSL)||this;t.$connection=null;t.$connection=e;t.$connection.addEventListener(C.SOCKET_CONNECTED,t.$onConnected,t,false,suncom.EventPriorityEnum.FWL);t.$connection.addEventListener(C.SOCKET_DISCONNECTED,t.$onDisconnected,t,false,suncom.EventPriorityEnum.FWL);return t}e.prototype.destroy=function(){if(this.$destroyed===true){return}n.prototype.destroy.call(this);this.$connection.removeEventListener(C.SOCKET_CONNECTED,this.$onConnected,this);this.$connection.removeEventListener(C.SOCKET_DISCONNECTED,this.$onDisconnected,this);this.$connection=null};e.prototype.$onConnected=function(){};e.prototype.$onDisconnected=function(e){};e.prototype.send=function(e,t,n,o){return[e,t,n,o]};e.prototype.recv=function(e,t,n,o){return[e,t,n,o]};return e}(puremvc.Notifier);e.NetConnectionInterceptor=o;var c=function(t){__extends(e,t);function e(){var e=t!==null&&t.apply(this,arguments)||this;e.$trackers=[];return e}e.prototype.$onConnected=function(){this.$trackers.length=0};e.prototype.send=function(e,t,n,o){if(this.$isReliableProtocal(e)===true){var i={rsp:e,rep:this.$getProtocalReplyCommand(e),time:(new Date).valueOf()};this.$trackers.push(i)}return[e,t,n,o]};e.prototype.recv=function(e,t,n,o){if(this.$trackers.length>0){var i=this.$trackers[0];if(i.rep===e){this.$trackers.shift();this.$connection.ping=(new Date).valueOf()-i.time;this.$dealRecvData(e,o)}}return[e,t,n,o]};e.prototype.$updateServerTimestamp=function(e,t){var n=Math.ceil(this.$connection.ping/2);if(t===i.RESET||n<this.$connection.latency){this.$connection.srvTime=e;this.$connection.latency=n;this.$connection.clientTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){var o=this.$connection.srvTime+suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)-this.$connection.clientTime;suncom.Logger.log(suncom.DebugMode.ANY,"服务器时间："+suncom.Common.formatDate("yy-MM-dd hh:mm:ss MS",o)+"，Ping："+this.$connection.ping+"，时间推算延延："+this.$connection.latency)}};return e}(o);e.NetConnectionPing=c;var a=function(n){__extends(e,n);function e(e){var t=n.call(this)||this;t.$items=[];t.$connection=e;return t}e.prototype.destroy=function(){if(this.$destroyed===true){return}n.prototype.destroy.call(this);while(this.$items.length>0){var e=this.$items.shift();e.interceptor.destroy()}};e.prototype.add=function(e,t){var n=new l;n.type=typeof e==="string"?e:null;n.interceptor=typeof e!=="string"?new e(this.$connection):new t(this.$connection);this.$items.push(n)};e.prototype.remove=function(e){for(var t=0;t<this.$items.length;t++){var n=this.$items[t].interceptor;if(n instanceof e){this.$items.splice(t,1);n.destroy();break}}};e.prototype.recv=function(e,t,n,o){var i=[e,t,n,o];for(var s=0;s<this.$items.length;s++){var r=this.$items[s];if(r.type==="send"){continue}var u=r.interceptor;i=u.recv.apply(u,i);if(i===null){return}}if(i[3]===void 0){suncom.Logger.warn(suncom.DebugMode.ANY,"NetConnectionPipeline=> decode 意外的指令 cmd:"+i[0].toString()+", buff:"+(i[1]?"[Object]":"null"))}};e.prototype.send=function(e,t,n,o){for(var i=this.$items.length-1;i>-1;i--){var s=this.$items[i];if(s.type==="recv"){continue}var r=s.interceptor;var u=r.send.call(r,e,t,n,o);if(u===null){return null}}return null};return e}(puremvc.Notifier);e.NetConnectionPipeline=a;var l=function(){function e(){}return e}();e.NetConnectionPipelineItem=l;var E=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.recv=function(e,t,n,o){if(o!==void 0){return[e,t,n,o]}var i=this.$decode(e,n);if(i===null){return[e,t,n,o]}if(i===n){throw Error("请勿返回未处理的消息！！！")}var s={id:e,name:null,data:i};if(y.VIRTUAL_NETWORK_LEVEL===u.NONE){suncore.MsgQ.send(suncore.MsgQModEnum.NSL,r.NSL_RECV_DATA,s)}else{this.$connection.dispatchEvent(C.SOCKET_MESSAGE_DECODED,s)}return[e,t,n,i]};return t}(o);e.NetConnectionProtobufDecoder=E;var d=function(t){__extends(e,t);function e(){var e=t!==null&&t.apply(this,arguments)||this;e.$datas=[];e.$currentSeconds=0;e.$isNetworkWaving=false;e.$lastConnectedTimestamp=0;e.$currentConnectionReliableTime=0;return e}e.prototype.$onConnected=function(){this.$lastConnectedTimestamp=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.$currentConnectionReliableTime=this.$getReliableTimeOfConnection()*1e3;this.facade.registerObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this);this.$connection.addEventListener(C.SOCKET_MESSAGE_DECODED,this.$onSocketMessageDecoded,this)};e.prototype.$onDisconnected=function(e){this.$datas.length=0;this.$currentSeconds=0;this.facade.removeObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this);this.$connection.removeEventListener(C.SOCKET_MESSAGE_DECODED,this.$onSocketMessageDecoded,this)};e.prototype.$onEnterFrame=function(){var e=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);if(this.$lastConnectedTimestamp>0&&e>this.$lastConnectedTimestamp+this.$currentConnectionReliableTime){this.$connection.dispatchEvent(C.CLOSE_CONNECT_BY_VIRTUAL);return}var t=Math.floor(e/1e3);if(this.$currentSeconds!==t){this.$currentSeconds=t;this.$isNetworkWaving=suncom.Mathf.random(0,100)<this.$getProbabilyOfNetworkWave()}if(this.$datas.length>0){var n=this.$datas[0];if(e>n.time+n.delay){suncore.MsgQ.send(suncore.MsgQModEnum.NSL,r.NSL_RECV_DATA,this.$datas.shift().msg)}}};e.prototype.$onSocketMessageDecoded=function(e){var t={msg:e,time:suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM),delay:this.$calculateMessageDelayTime()};this.$datas.push(t)};e.prototype.$getReliableTimeOfConnection=function(){if(y.VIRTUAL_NETWORK_LEVEL===u.UNSTABLE){return suncom.Mathf.random(180,300)}else{return 1440*30}};e.prototype.$getProbabilyOfNetworkWave=function(){if(y.VIRTUAL_NETWORK_LEVEL===u.BAD){return 10}else if(y.VIRTUAL_NETWORK_LEVEL===u.UNSTABLE){return 25}else{return 0}};e.prototype.$calculateMessageDelayTime=function(){if(y.VIRTUAL_NETWORK_LEVEL===u.GOOD){return suncom.Mathf.random(60,150)}else if(y.VIRTUAL_NETWORK_LEVEL===u.BAD){if(this.$isNetworkWaving===false){return suncom.Mathf.random(200,800)}else{return suncom.Mathf.random(1e3,2e3)}}else if(y.VIRTUAL_NETWORK_LEVEL===u.UNSTABLE){if(this.$isNetworkWaving===false){return suncom.Mathf.random(1e3,2500)}else{return suncom.Mathf.random(3e3,8e3)}}else{return 0}};return e}(o);e.NetConnectionVirtualNetwork=d;var m=function(n){__extends(e,n);function e(e){var t=n.call(this,e)||this;t.$retryer=null;t.$retryer=new sunui.Retryer(sunui.RetryMethodEnum.TERMINATE,suncom.Handler.create(t,t.$onConnectFailed,[e.name]));t.$connection.addEventListener(C.KILL_WATCH_DOG,t.$onKillWatchDog,t);return t}e.prototype.destroy=function(){if(this.$destroyed===true){return}this.$connection.removeEventListener(C.KILL_WATCH_DOG,this.$onKillWatchDog,this);n.prototype.destroy.call(this)};e.prototype.$onConnected=function(){this.$retryer.cancel();this.$retryer.reset()};e.prototype.$onDisconnected=function(e){if(e===true){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"NetConnectionWatchDog=> 网络连接异常，"+y.TCP_RETRY_DELAY+"毫秒后重连！")}this.$ip=this.$connection.ip;this.$port=this.$connection.port;this.$retryer.run(y.TCP_RETRY_DELAY,suncom.Handler.create(this,this.$doConnect),y.TCP_MAX_RETRIES)}};e.prototype.$onKillWatchDog=function(){this.$retryer.cancel()};e.prototype.$doConnect=function(){if(this.$connection.state===s.DISCONNECTED){this.$connection.connect(this.$ip,this.$port,true)}else if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"检测狗不能正常工作，因为 state:"+s[this.$connection.state])}};e.prototype.$onConnectFailed=function(e){this.$retryer.reset();this.facade.sendNotification(v.SOCKET_CONNECT_FAILED,e)};return e}(o);e.NetConnectionWatchDog=m;var h=function(){function e(){this.$proto=null;this.$commands=null;this.$protocals=null}e.getInstance=function(){return e.instance};e.prototype.buildProto=function(e){var t=new Laya.Browser.window.protobuf.Root;var n=Laya.loader.getRes(e);Laya.Browser.window.protobuf.parse(n,t,{keepCase:true});this.$proto=t};e.prototype.buildProtocal=function(e){var t=Laya.loader.getRes(e);this.$commands=Object.keys(t.data);this.$protocals=t.data};e.prototype.buildProtocalJson=function(e){this.$commands=Object.keys(e);this.$protocals=e};e.prototype.getProtocalByCommand=function(e){return this.$protocals[e]||null};e.prototype.getProtocalByName=function(e){for(var t=0;t<this.$commands.length;t++){var n=this.$commands[t];var o=this.getProtocalByCommand(n);if(o===null){continue}if(o.Name===e){return o}}return null};e.prototype.getProtoClass=function(e){return this.$proto.lookup(e)};e.prototype.getProtoEnum=function(e){return this.getProtoClass(e).values};e.prototype.encode=function(e,t){if(suncom.Global.debugMode&suncom.DebugMode.DEBUG){if(e==="msg.Common_Heartbeat"){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"打包心跳成功 ==> "+JSON.stringify(t))}}else if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"打包数据成功 ==> "+JSON.stringify(t))}}return this.getProtoClass(e).encode(t).finish()};e.prototype.decode=function(e,t){var n=this.getProtoClass(e).decode(t);if(suncom.Global.debugMode&suncom.DebugMode.DEBUG){if(e==="msg.Common_Heartbeat"){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"解析心跳成功 ==> "+JSON.stringify(n))}}else if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"解析数据成功 ==> "+JSON.stringify(n))}}return n};e.instance=new e;return e}();e.ProtobufManager=h;var f=function(t){__extends(e,t);function e(){var e=t.call(this)||this;e.$hashId=suncom.Common.createHashId();e.$destroyed=false;e.facade.registerObserver(suncore.NotifyKey.ENTER_FRAME,e.$onEnterFrameCB,e,false,suncom.EventPriorityEnum.FWL);return e}e.prototype.release=function(){if(this.$destroyed===true){return}this.$destroyed=true;this.facade.removeObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrameCB,this)};e.prototype.$onEnterFrameCB=function(){if(this.$destroyed===false){this.$onEnterFrame()}};Object.defineProperty(e.prototype,"hashId",{get:function(){return this.$hashId},enumerable:true,configurable:true});return e}(puremvc.Notifier);e.SequentialSlice=f;var p=function(o){__extends(e,o);function e(e,t){if(t===void 0){t="default"}var n=o.call(this)||this;n.$connection=null;n.$srvCreateTime=0;n.$lifeTime=0;n.$pastTime=0;n.$killedTime=0;n.$timeMultiple=1;n.$chaseMultiple=1;n.$lifeTime=e;n.$connection=S.connetionMap[t]||null;n.$srvCreateTime=D(t);return n}e.prototype.updateCreateTime=function(e,t,n){if(e===void 0){e=0}if(t===void 0){t=0}if(n===void 0){n=1}this.$pastTime=t;this.$chaseMultiple=n;this.$srvCreateTime=e>0?e:this.$srvCreateTime;this.$onEnterFrame()};e.prototype.$onEnterFrame=function(){if(this.$timeMultiple<0){suncom.Logger.error(suncom.DebugMode.ANY,"当前时间流逝倍率不允许小于0");return}var e=suncore.System.getDelta()*this.$timeMultiple;if(e<suncore.System.getDelta()){this.$killedTime+=suncore.System.getDelta()-e}if(this.$timeMultiple===0){return}this.$pastTime+=e;var t=D(this.$connection.name)-(this.$srvCreateTime+this.$pastTime+this.$killedTime);if(t>0){e*=this.$chaseMultiple;if(e>t){e=t}this.$pastTime+=e}if(this.$pastTime>this.$lifeTime){this.$pastTime=this.$lifeTime}this.$frameLoop();if(this.$pastTime>=this.$lifeTime){this.$onTimeup()}};Object.defineProperty(e.prototype,"timeLen",{get:function(){return this.$lifeTime},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"pastTime",{get:function(){return this.$pastTime},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"timeMultiple",{get:function(){return this.$timeMultiple},set:function(e){this.$timeMultiple=e},enumerable:true,configurable:true});return e}(f);e.SequentialTimeSlice=p;var T=function(n){__extends(e,n);function e(e){var t=n.call(this,e)||this;t.$datas=[];t.$cacheSendBytes=false;t.$connection.addEventListener(C.CACHE_SEND_BYTES,t.$onCacheSendBytes,t);t.$connection.addEventListener(C.FLUSH_CACHED_BYTES,t.$onFlushCachedBytes,t);t.$connection.addEventListener(C.CLEAR_REQUEST_DATA,t.$onClearRequestData,t);return t}e.prototype.destroy=function(){if(this.$destroyed===true){return}this.$connection.removeEventListener(C.CACHE_SEND_BYTES,this.$onCacheSendBytes,this);this.$connection.removeEventListener(C.FLUSH_CACHED_BYTES,this.$onFlushCachedBytes,this);this.$connection.removeEventListener(C.CLEAR_REQUEST_DATA,this.$onClearRequestData,this);n.prototype.destroy.call(this)};e.prototype.$onCacheSendBytes=function(e){this.$cacheSendBytes=e};e.prototype.$onFlushCachedBytes=function(){while(this.$datas.length>0&&this.$connection.state===s.CONNECTED){var e=this.$datas.shift();this.$connection.sendBytes(e.cmd,e.bytes,e.ip,e.port)}};e.prototype.$onClearRequestData=function(){this.$datas.length=0};e.prototype.$needCreate=function(e,t){if(e===null||t===0){return false}if(this.$connection.state===s.DISCONNECTED){return true}if(this.$connection.state===s.CONNECTED){if(this.$connection.ip!==e||this.$connection.port!==t){return true}}return false};e.prototype.send=function(e,t,n,o){if(this.$needCreate(n,o)==true){this.$connection.connect(n,o,false);this.$cacheSendBytes=true}if(this.$connection.state===s.CONNECTED){return[e,t,n,o]}else if(this.$cacheSendBytes===true){var i={cmd:e,bytes:t,ip:n,port:o};this.$datas.push(i)}return null};return e}(o);e.NetConnectionCreator=T;var $=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.recv=function(e,t,n,o){var i=false;if(suncom.Global.debugMode&suncom.DebugMode.TDD){if(o!==null){var s=h.getInstance().getProtocalByCommand(e);n=h.getInstance().encode("msg."+s.Name,o)}i=true;o=void 0}if(i===false){var r=this.$connection.input||null;if(r===null){suncom.Logger.error(suncom.DebugMode.ANY,"Decoder 网络己断开！！！");return null}e=r.getUint16();t=r.getUint16();var u=r.buffer.slice(r.pos);r.pos+=u.byteLength;i=true;n=new Uint8Array(u)}return[e,t,n,o]};return t}(o);e.NetConnectionDecoder=$;var g=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.send=function(e,t,n,o){if(suncom.Global.debugMode&suncom.DebugMode.TDD){this.$connection.testPacket(e);this.$connection.logMsgIsSent(e,t,n,o);return null}var i=this.$connection.output||null;if(i===null){suncom.Logger.error(suncom.DebugMode.ANY,"Encoder 网络己断开！！！");return null}i.writeUint16(e);i.writeUint16(0);t!==null&&i.writeArrayBuffer(t);this.$connection.flush();this.$connection.logMsgIsSent(e,t,n,o);return null};return t}(o);e.NetConnectionEncoder=g;var N=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.$onConnected=function(){this.$lastRecvTime=this.$lastSendTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.facade.registerObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this)};t.prototype.$onDisconnected=function(){this.facade.removeObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this)};t.prototype.$onEnterFrame=function(){var e=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);if(this.$lastRecvTime<this.$lastSendTime){if(e-this.$lastSendTime>y.HEARTBEAT_TIMEOUT_MILLISECONDS){this.$lastRecvTime=this.$lastSendTime;this.$connection.close(true)}}else if(e-this.$lastSendTime>y.HEARTBEAT_INTERVAL_MILLISECONDS){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"heartbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}var t=h.getInstance().encode("msg.Common_Heartbeat",{Cnt:1});this.$connection.sendBytes(y.HEARTBEAT_REQUEST_COMMAND,t)}};t.prototype.send=function(e,t,n,o){if(y.HEARTBEAT_FIXED_FREQUENCY===false||e===y.HEARTBEAT_REQUEST_COMMAND){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){if(e===y.HEARTBEAT_REQUEST_COMMAND){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"send heartbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}}else if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"send bytes=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}}this.$lastSendTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}return[e,t,n,o]};t.prototype.recv=function(e,t,n,o){if(y.HEARTBEAT_FIXED_FREQUENCY===false||e===y.HEARTBEAT_RESPONSE_COMMAND){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){if(e===y.HEARTBEAT_RESPONSE_COMMAND){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"recv heartbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}}else if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"recv bytes=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}}this.$lastRecvTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}return[e,t,n,o]};return t}(o);e.NetConnectionHeartbeat=N;var y;(function(e){e.TCP_RETRY_DELAY=20*1e3;e.TCP_MAX_RETRIES=10;e.HEARTBEAT_REQUEST_COMMAND=-1;e.HEARTBEAT_RESPONSE_COMMAND=-1;e.HEARTBEAT_TIMEOUT_MILLISECONDS=3e3;e.HEARTBEAT_INTERVAL_MILLISECONDS=5e3;e.HEARTBEAT_FIXED_FREQUENCY=false;e.VIRTUAL_NETWORK_LEVEL=u.NONE})(y=e.Config||(e.Config={}));var C;(function(e){e.SOCKET_CONNECTED="sunnet.EventKey.SOCKET_CONNECTED";e.SOCKET_DISCONNECTED="sunnet.EventKey.SOCKET_DISCONNECTED";e.SOCKET_CONNECTING="sunnet.EventKey.SOCKET_CONNECTING";e.SOCKET_CONNECT_FAILED="sunnet.EventKey.SOCKET_CONNECT_FAILED";e.KILL_WATCH_DOG="sunnet.EventKey.KILL_WATCH_DOG";e.CACHE_SEND_BYTES="sunnet.EventKey.CACHE_SEND_BYTES";e.FLUSH_CACHED_BYTES="sunnet.EventKey.FLUSH_CACHED_BYTES";e.CLEAR_REQUEST_DATA="sunnet.EventKey.CLEAR_REQUEST_DATA";e.SOCKET_MESSAGE_DECODED="sunnet.EventKey.SOCKET_MESSAGE_DECODED";e.CLOSE_CONNECT_BY_VIRTUAL="sunnet.EventKey.CLOSE_CONNECT_BY_VIRTUAL"})(C=e.EventKey||(e.EventKey={}));var S;(function(e){e.HEAD_LENGTH=28;e.connetionMap={}})(S=e.M||(e.M={}));var _;(function(e){var i=new suncom.EventSystem;function t(e,t,n){if(e==="msg.Common_Heartbeat"){if(suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log(suncom.DebugMode.ANY,"响应心跳")}}else{if(suncom.Global.debugMode&suncom.DebugMode.NETWORK){suncom.Logger.log(suncom.DebugMode.ANY,"响应消息 name:"+e+", data:"+JSON.stringify(t))}}i.dispatchEvent(e,t,n)}e.notify=t;function n(e,t,n,o){i.addEventListener(e,t,n,false,o)}e.register=n;function o(e,t,n){i.removeEventListener(e,t,n)}e.unregister=o})(_=e.MessageNotifier||(e.MessageNotifier={}));var v;(function(e){e.SOCKET_STATE_CHANGE="sunnet.NotifyKey.SOCKET_STATE_CHANGE";e.SOCKET_CONNECT_FAILED="sunnet.NotifyKey.SOCKET_CONNECT_FAILED";e.SEQUENTIAL_SLICE_RELEASED="sunnet.NotifyKey.SEQUENTIAL_SLICE_RELEASED";e.GUI_SEQUENTIAL_NOTIFICATION="sunnet.NotifyKey.GUI_SEQUENTIAL_NOTIFICATION"})(v=e.NotifyKey||(e.NotifyKey={}));function D(e){if(e===void 0){e="default"}var t=S.connetionMap[e]||null;if(t===null){return 0}return t.srvTime+suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)-t.clientTime}e.getCurrentServerTimestamp=D})(sunnet||(sunnet={}));