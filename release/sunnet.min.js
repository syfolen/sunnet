var __extends=this&&this.__extends||function(){var o=function(e,t){o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return o(e,t)};return function(e,t){o(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}}();var sunnet;(function(e){var t;(function(e){e[e["OK"]=0]="OK";e[e["IO_ERROR"]=-1]="IO_ERROR";e[e["PARSE_ERROR"]=-2]="PARSE_ERROR"})(t=e.HttpResStatus||(e.HttpResStatus={}));var r;(function(e){e[e["NSL_SEND_DATA"]=1]="NSL_SEND_DATA";e[e["NSL_RECV_DATA"]=2]="NSL_RECV_DATA"})(r=e.MsgQIdEnum||(e.MsgQIdEnum={}));var c;(function(e){e[e["CONNECTED"]=0]="CONNECTED";e[e["CONNECTING"]=1]="CONNECTING";e[e["DISCONNECTED"]=2]="DISCONNECTED"})(c=e.NetConnectionStateEnum||(e.NetConnectionStateEnum={}));var n=function(n){__extends(e,n);function e(e){var t=n.call(this,suncore.MsgQModEnum.NSL)||this;t.$closedByError=false;t.$socket=null;t.$state=c.DISCONNECTED;t.$pipeline=null;t.$dispatcher=null;t.$name=e;t.$pipeline=new s(t);t.$dispatcher=new suncom.EventSystem;return t}e.prototype.connect=function(e,t,n){var o=n===false?false:this.$closedByError;this.close(o);this.$ip=e;this.$port=t;this.$state=c.CONNECTING;this.$socket=new Laya.Socket;this.$socket.endian=Laya.Byte.LITTLE_ENDIAN;this.$socket.on(Laya.Event.OPEN,this,this.$onOpen);this.$socket.on(Laya.Event.CLOSE,this,this.$onClose);this.$socket.on(Laya.Event.ERROR,this,this.$onError);this.$socket.on(Laya.Event.MESSAGE,this,this.$onMessage);this.$socket.connectByUrl("ws://"+e+":"+t);if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 请求连接 ws://"+this.$ip+":"+this.$port)}this.facade.sendNotification(N.SOCKET_STATE_CHANGE,[this.$name,this.$state])};e.prototype.close=function(e){if(e===void 0){e=false}if(e===false){this.$closedByError=false}else if(this.$state===c.CONNECTED){this.$closedByError=true;this.dispatchEvent(m.CLEAR_MESSAGE_QUEUE)}if(this.$socket!==null){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 关闭连接 ws://"+this.$ip+":"+this.$port)}this.$socket.off(Laya.Event.OPEN,this,this.$onOpen);this.$socket.off(Laya.Event.CLOSE,this,this.$onClose);this.$socket.off(Laya.Event.ERROR,this,this.$onError);this.$socket.off(Laya.Event.MESSAGE,this,this.$onMessage);this.$socket.close();this.$socket=null}if(this.$state!==c.DISCONNECTED){this.dispatchEvent(m.SOCKET_DISCONNECTED,e)}if(e===false){this.dispatchEvent(m.KILL_WATCH_DOG)}if(this.$state!==c.DISCONNECTED){this.$state=c.DISCONNECTED;this.facade.sendNotification(N.SOCKET_STATE_CHANGE,[this.$name,this.$state])}};e.prototype.send=function(e){if(this.$state===c.CONNECTED){this.$socket.send(e)}if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.error("NetConnection=> sendBytes 发送数据失败！！！")}};e.prototype.flush=function(){this.$socket.flush()};e.prototype.sendBytes=function(e,t,n,o,s){if(t===void 0){t=null}if(n===void 0){n=null}if(o===void 0){o=0}if(s===void 0){s=true}this.$pipeline.send(e,t,n,o,s)};e.prototype.$onOpen=function(){this.$state=c.CONNECTED;if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 网络连接成功！")}if(this.$closedByError===true){this.$closedByError=false;this.facade.sendNotification(N.SOCKET_STATE_CHANGE,[this.$name,this.$state])}this.dispatchEvent(m.SOCKET_CONNECTED)};e.prototype.$onClose=function(){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 连接异常关闭！")}this.close(true)};e.prototype.$onError=function(){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("Netconnection=> 连接异常断开！")}this.close(true)};e.prototype.$onMessage=function(e){this.$pipeline.recv(0,0,null,void 0)};e.prototype.dispatchCancel=function(){this.$dispatcher.dispatchCancel()};e.prototype.dispatchEvent=function(e,t,n){this.$dispatcher.dispatchEvent(e,t,n)};e.prototype.addEventListener=function(e,t,n,o,s){this.$dispatcher.addEventListener(e,t,n,o,s)};e.prototype.removeEventListener=function(e,t,n){this.$dispatcher.removeEventListener(e,t,n)};Object.defineProperty(e.prototype,"name",{get:function(){return this.$name},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"ip",{get:function(){return this.$ip||null},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"port",{get:function(){return this.$port||0},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"state",{get:function(){return this.$state},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"input",{get:function(){var e=this.$socket||null;if(e===null){return null}return this.$socket.input||null},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"output",{get:function(){var e=this.$socket||null;if(e===null){return null}return this.$socket.output||null},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"pipeline",{get:function(){return this.$pipeline},enumerable:true,configurable:true});e.HEAD_LENGTH=28;return e}(puremvc.Notifier);e.NetConnection=n;var o=function(n){__extends(e,n);function e(e){var t=n.call(this,suncore.MsgQModEnum.NSL)||this;t.$connection=null;t.$connection=e;t.$connection.addEventListener(m.SOCKET_CONNECTED,t.$onConnected,t);t.$connection.addEventListener(m.SOCKET_DISCONNECTED,t.$onDisconnected,t);return t}e.prototype.destroy=function(){this.$connection.removeEventListener(m.SOCKET_CONNECTED,this.$onConnected,this);this.$connection.removeEventListener(m.SOCKET_DISCONNECTED,this.$onDisconnected,this);this.$connection=null};e.prototype.$onConnected=function(){};e.prototype.$onDisconnected=function(e){};e.prototype.send=function(e,t,n,o,s){return[e,t,n,o]};e.prototype.recv=function(e,t,n,o){return[e,t,n,o]};return e}(puremvc.Notifier);e.NetConnectionInterceptor=o;var s=function(){function e(e){this.$items=[];this.$connection=e}e.prototype.destroy=function(){while(this.$items.length>0){var e=this.$items.shift();e.interceptor.destroy()}};e.prototype.add=function(e,t){var n=new i;n.type=typeof e==="string"?e:null;n.interceptor=typeof e!=="string"?new e(this.$connection):new t(this.$connection);this.$items.push(n)};e.prototype.remove=function(e){for(var t=0;t<this.$items.length;t++){var n=this.$items[t].interceptor;if(n instanceof e){this.$items.splice(t,1);n.destroy();break}}};e.prototype.recv=function(e,t,n,o){var s=[e,t,n,o];for(var i=0;i<this.$items.length;i++){var r=this.$items[i];if(r.type==="send"){continue}var c=r.interceptor;s=c.recv.apply(c,s);if(s===null){return}}if(s[3]===void 0){if(suncom.Global.debugMode){suncom.Logger.warn("NetConnectionPipeline=> decode 意外的指令 cmd:"+s[0].toString()+", buff:"+(s[1]?"[Object]":"null"))}}};e.prototype.send=function(e,t,n,o,s){for(var i=this.$items.length-1;i>-1;i--){var r=this.$items[i];if(r.type==="recv"){continue}var c=r.interceptor;var u=c.send.call(c,e,t,n,o,s);if(u===null){return null}}return null};return e}();e.NetConnectionPipeline=s;var i=function(){function e(){}return e}();e.NetConnectionPipelineItem=i;var u=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.recv=function(e,t,n,o){if(o!==void 0){return[e,t,n,o]}var s=this.$decode(e,n);if(s===null){return[e,t,n,o]}if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("消息解析成功 ==> "+JSON.stringify(s))}if(s===n){throw Error("请勿返回未处理的消息！！！")}var i={id:e,name:null,data:s};suncore.MsgQ.send(suncore.MsgQModEnum.NSL,r.NSL_RECV_DATA,i);return[e,t,n,s]};return t}(o);e.NetConnectionProtobufDecoder=u;var a=function(n){__extends(e,n);function e(e){var t=n.call(this,e)||this;t.$retryer=null;t.$retryer=new sunui.Retryer(sunui.RetryMethodEnum.TERMINATE,suncom.Handler.create(t,t.$onConnectFailed,[e.name]));t.$connection.addEventListener(m.KILL_WATCH_DOG,t.$onKillWatchDog,t);return t}e.prototype.destroy=function(){this.$connection.removeEventListener(m.KILL_WATCH_DOG,this.$onKillWatchDog,this);n.prototype.destroy.call(this)};e.prototype.$onConnected=function(){this.$retryer.cancel();this.$retryer.reset()};e.prototype.$onDisconnected=function(e){if(e===true){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT)===suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log("NetConnectionWatchDog=> 网络连接异常，"+d.TCP_RETRY_DELAY+"毫秒后重连！")}this.$ip=this.$connection.ip;this.$port=this.$connection.port;this.$retryer.run(d.TCP_RETRY_DELAY,suncom.Handler.create(this,this.$doConnect),d.TCP_MAX_RETRIES)}};e.prototype.$onKillWatchDog=function(){this.$retryer.cancel()};e.prototype.$doConnect=function(){if(this.$connection.state===c.DISCONNECTED){this.$connection.connect(this.$ip,this.$port,true)}else{if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("检测狗不能正常工作，因为 state:"+c[this.$connection.state])}}};e.prototype.$onConnectFailed=function(e){this.$retryer.reset();this.facade.sendNotification(N.SOCKET_CONNECT_FAILED,e)};return e}(o);e.NetConnectionWatchDog=a;var E=function(){function e(){this.$proto=null;this.$commands=null;this.$protocals=null}e.getInstance=function(){return e.instance};e.prototype.buildProto=function(e){var t=new Laya.Browser.window.protobuf.Root;var n=Laya.loader.getRes(e);Laya.Browser.window.protobuf.parse(n,t,{keepCase:true});this.$proto=t};e.prototype.buildProtocal=function(e){var t=Laya.loader.getRes(e);this.$commands=Object.keys(t.data);this.$protocals=t.data};e.prototype.buildProtocalJson=function(e){this.$commands=Object.keys(e);this.$protocals=e};e.prototype.getProtocalByCommand=function(e){return this.$protocals[e]||null};e.prototype.getProtocalByName=function(e){for(var t=0;t<this.$commands.length;t++){var n=this.$commands[t];var o=this.getProtocalByCommand(n);if(o===null){continue}if(o.Name===e){return o}}return null};e.prototype.getProtoClass=function(e){return this.$proto.lookup(e)};e.prototype.getProtoEnum=function(e){return this.getProtoClass(e).values};e.prototype.encode=function(e,t){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){console.log("打包数据成功 ==> "+JSON.stringify(t))}return this.getProtoClass(e).encode(t).finish()};e.prototype.decode=function(e,t){return this.getProtoClass(e).decode(t)};e.instance=new e;return e}();e.ProtobufManager=E;var l=function(n){__extends(e,n);function e(e){var t=n.call(this,e)||this;t.$messages=[];t.$connection.addEventListener(m.CLEAR_MESSAGE_QUEUE,t.$onClearMessageQueue,t);return t}e.prototype.destroy=function(){this.$connection.removeEventListener(m.CLEAR_MESSAGE_QUEUE,this.$onClearMessageQueue,this);n.prototype.destroy.call(this)};e.prototype.$onConnected=function(){while(this.$messages.length>0){var e=this.$messages.pop();this.$connection.sendBytes(e.cmd,e.bytes,e.ip,e.port,e.care)}};e.prototype.$onClearMessageQueue=function(){this.$messages.length=0};e.prototype.$needCreate=function(e,t){if(e===null||t===0){return false}if(this.$connection.state===c.DISCONNECTED){return true}if(this.$connection.state===c.CONNECTED){if(this.$connection.ip!==e||this.$connection.port!==t){return true}}return false};e.prototype.send=function(e,t,n,o,s){if(this.$needCreate(n,o)==false){if(this.$connection.state===c.CONNECTING){return null}return[e,t,n,o,s]}if(n!==null&&o!==0){this.$connection.connect(n,o,false)}var i={cmd:e,bytes:t,ip:n,port:o,care:s};this.$messages.push(i);return null};return e}(o);e.NetConnectionCreator=l;var f=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.recv=function(e,t,n,o){var s=this.$connection.input||null;if(s===null){console.error("Decoder 网络己断开！！！");return}e=s.getUint16();t=s.getUint16();var i=s.buffer.slice(s.pos);s.pos+=i.byteLength;n=new Uint8Array(i);if(e===d.HEARTBEAT_RESPONSE_COMMAND){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT)===suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log("响应心跳")}}else{if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("NetConnection=> 响应消息 cmd:"+e+", srvId:"+t+", length:"+n.byteLength)}}return[e,t,n,o]};return t}(o);e.NetConnectionDecoder=f;var h=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.send=function(e,t,n,o,s){var i=this.$connection.output||null;if(i===null){console.error("Encoder 网络己断开！！！");return}i.writeUint16(e);i.writeUint16(0);t!==null&&i.writeArrayBuffer(t);this.$connection.flush();if(e===d.HEARTBEAT_REQUEST_COMMAND){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK_HEARTBEAT)===suncom.DebugMode.NETWORK_HEARTBEAT){suncom.Logger.log("发送数据 cmd:"+e.toString()+", bytes:"+(t===null?0:t.byteLength))}}else if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("发送数据 cmd:"+e.toString()+", bytes:"+(t===null?0:t.byteLength))}return null};return t}(o);e.NetConnectionEncoder=h;var p=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.$onConnected=function(){this.$lastRecvTime=this.$lastSendTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);this.facade.registerObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this)};t.prototype.$onDisconnected=function(){this.facade.removeObserver(suncore.NotifyKey.ENTER_FRAME,this.$onEnterFrame,this)};t.prototype.$onEnterFrame=function(){var e=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM);if(this.$lastRecvTime<this.$lastSendTime){if(e-this.$lastSendTime>d.HEARTBEAT_TIMEOUT_MILLISECONDS){this.$lastRecvTime=this.$lastSendTime;this.$connection.close(true)}}else if(e-this.$lastSendTime>d.HEARTBEAT_INTERVAL_MILLISECONDS){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){suncom.Logger.log("heartbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}var t=E.getInstance().encode("msg.Common_Heartbeat",{Cnt:1});this.$connection.sendBytes(d.HEARTBEAT_REQUEST_COMMAND,t)}};t.prototype.send=function(e,t,n,o,s){if(s===true){if(d.HEARTBEAT_FIXED_FREQUENCY===false||e===d.HEARTBEAT_REQUEST_COMMAND){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){if(e===d.HEARTBEAT_REQUEST_COMMAND){suncom.Logger.log("send heartbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}else{suncom.Logger.log("send bytes=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}}this.$lastSendTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}}return[e,t,n,o,false]};t.prototype.recv=function(e,t,n,o){if(d.HEARTBEAT_FIXED_FREQUENCY===false||e===d.HEARTBEAT_RESPONSE_COMMAND){if((suncom.Global.debugMode&suncom.DebugMode.NETWORK)===suncom.DebugMode.NETWORK){if(e===d.HEARTBEAT_RESPONSE_COMMAND){suncom.Logger.log("recv heartbeat=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}else{suncom.Logger.log("recv bytes=> current timestamp:"+suncom.Common.formatDate("hh:mm:ss MS",(new Date).valueOf()))}}this.$lastRecvTime=suncore.System.getModuleTimestamp(suncore.ModuleEnum.SYSTEM)}return[e,t,n,o]};return t}(o);e.NetConnectionHeartBeat=p;var d;(function(e){e.TCP_RETRY_DELAY=20*1e3;e.TCP_MAX_RETRIES=10;e.HEARTBEAT_REQUEST_COMMAND=-1;e.HEARTBEAT_RESPONSE_COMMAND=-1;e.HEARTBEAT_TIMEOUT_MILLISECONDS=3e3;e.HEARTBEAT_INTERVAL_MILLISECONDS=5e3;e.HEARTBEAT_FIXED_FREQUENCY=false})(d=e.Config||(e.Config={}));var m;(function(e){e.SOCKET_CONNECTED="sunnet.EventKey.SOCKET_CONNECTED";e.SOCKET_DISCONNECTED="sunnet.EventKey.SOCKET_DISCONNECTED";e.SOCKET_CONNECTING="sunnet.EventKey.SOCKET_CONNECTING";e.SOCKET_CONNECT_FAILED="sunnet.EventKey.SOCKET_CONNECT_FAILED";e.KILL_WATCH_DOG="sunnet.EventKey.KILL_WATCH_DOG";e.CLEAR_MESSAGE_QUEUE="sunnet.EventKey.CLEAR_MESSAGE_QUEUE"})(m=e.EventKey||(e.EventKey={}));var T;(function(e){var o=new suncom.EventSystem;function t(e,t){o.dispatchEvent(e,t)}e.notify=t;function n(e,t,n){o.addEventListener(e,t,n)}e.register=n;function s(e,t,n){o.removeEventListener(e,t,n)}e.unregister=s})(T=e.MessageNotifier||(e.MessageNotifier={}));var N;(function(e){e.SOCKET_STATE_CHANGE="sunnet.NotifyKey.SOCKET_STATE_CHANGE";e.SOCKET_CONNECT_FAILED="sunnet.NotifyKey.SOCKET_CONNECT_FAILED"})(N=e.NotifyKey||(e.NotifyKey={}))})(sunnet||(sunnet={}));